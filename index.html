<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>çµ±åˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  Pro v2.3</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', sans-serif;
            background: #f8fafc;
            color: #1e293b;
        }

        /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        .container {
            display: flex;
            height: 100vh;
        }

        /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ */
        .sidebar {
            width: 260px;
            background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
            color: white;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 8px rgba(0,0,0,0.1);
        }

        .logo {
            padding: 24px 20px;
            font-size: 18px;
            font-weight: 700;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav {
            flex: 1;
            padding: 20px 0;
            overflow-y: auto;
        }

        .nav-item {
            padding: 12px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s;
            color: rgba(255,255,255,0.7);
            font-size: 14px;
        }

        .nav-item:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        .nav-item.active {
            background: rgba(59, 130, 246, 0.2);
            color: white;
            border-left: 3px solid #3b82f6;
            font-weight: 600;
        }

        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
        .main-content {
            flex: 1;
            overflow-y: auto;
            background: #f8fafc;
        }

        .header {
            background: white;
            padding: 20px 32px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            font-size: 24px;
            font-weight: 700;
            color: #1e293b;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .content {
            padding: 32px;
        }

        /* ãƒœã‚¿ãƒ³ */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #475569;
        }

        .btn-secondary:hover {
            background: #cbd5e1;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        /* ã‚«ãƒ¼ãƒ‰ */
        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 700;
            color: #1e293b;
        }

        /* é¡§å®¢ãƒªã‚¹ãƒˆ */
        .customer-list {
            display: grid;
            gap: 16px;
        }

        .customer-item {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .customer-item:hover {
            border-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
            transform: translateY(-2px);
        }

        .customer-item-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
        }

        .customer-name {
            font-size: 16px;
            font-weight: 700;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .customer-code {
            font-size: 12px;
            background: #dbeafe;
            color: #1e40af;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
        }

        .customer-info {
            display: grid;
            gap: 8px;
            font-size: 14px;
            color: #64748b;
        }

        .customer-info-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* ã‚¿ãƒ– */
        .tabs {
            display: flex;
            gap: 8px;
            border-bottom: 2px solid #e2e8f0;
            margin-bottom: 24px;
        }

        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
            color: #64748b;
            font-weight: 600;
        }

        .tab:hover {
            color: #3b82f6;
        }

        .tab.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
        }

        /* ãƒ•ã‚©ãƒ¼ãƒ  */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #334155;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-group small {
            display: block;
            margin-top: 4px;
            font-size: 12px;
            color: #64748b;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .form-group input[type="radio"] {
            margin: 0 !important;
            flex-shrink: 0 !important;
            width: 20px !important;
            height: 20px !important;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 24px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
        }

        .modal-body {
            padding: 24px;
        }

        .modal-footer {
            padding: 24px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #64748b;
        }

        .close-btn:hover {
            color: #1e293b;
        }

        /* æ¤œç´¢ãƒãƒ¼ */
        .search-bar {
            position: relative;
            margin-bottom: 24px;
        }

        .search-bar input {
            width: 100%;
            padding: 12px 44px 12px 44px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 14px;
        }

        .search-bar::before {
            content: 'ğŸ”';
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
        }

        .search-clear-btn {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #64748b;
            padding: 4px 8px;
            display: none;
        }

        .search-clear-btn:hover {
            color: #1e293b;
        }

        .search-clear-btn.show {
            display: block;
        }

        /* ã‚³ãƒ³ãƒ†ãƒŠã‚¢ã‚¤ãƒ†ãƒ  */
        .container-item {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .container-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .container-type {
            font-size: 16px;
            font-weight: 700;
            color: #1e293b;
        }

        .container-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .container-status.renting {
            background: #dcfce7;
            color: #166534;
        }

        .container-status.available {
            background: #f1f5f9;
            color: #475569;
        }

        .container-info {
            display: grid;
            gap: 8px;
            font-size: 14px;
            color: #64748b;
            margin-bottom: 12px;
        }

        .container-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .container-actions button {
            padding: 6px 12px;
            font-size: 12px;
        }

        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .loading.show {
            display: flex;
        }

        .loading-content {
            background: white;
            padding: 32px;
            border-radius: 12px;
            text-align: center;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #e2e8f0;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ç©ºçŠ¶æ…‹ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #64748b;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .empty-state-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #334155;
        }

        /* é€šçŸ¥ãƒãƒƒã‚¸ */
        .notification-badge {
            background: #ef4444;
            color: white;
            font-size: 11px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: auto;
        }

        /* é€šçŸ¥ãƒ‘ãƒãƒ« */
        .notifications-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 400px;
            height: 100vh;
            background: white;
            box-shadow: -2px 0 8px rgba(0,0,0,0.2);
            z-index: 1001;
            display: none;
            flex-direction: column;
        }

        .notifications-panel.show {
            display: flex;
        }

        .notifications-header {
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 700;
            font-size: 16px;
        }

        .notifications-list {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .notification-item {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .notification-item:hover {
            border-color: #3b82f6;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
        }

        .notification-item.warning {
            border-left: 4px solid #fbbf24;
            background: #fef3c7;
        }

        .notification-item.danger {
            border-left: 4px solid #ef4444;
            background: #fee2e2;
        }

        .notification-title {
            font-weight: 700;
            margin-bottom: 4px;
            color: #1e293b;
        }

        .notification-text {
            font-size: 13px;
            color: #64748b;
        }

        /* è«‹æ±‚æ—¥ã‚¢ãƒ©ãƒ¼ãƒˆ */
        .billing-alert {
            background: #fef3c7;
            border: 1px solid #fbbf24;
            border-radius: 8px;
            padding: 12px 16px;
            margin-top: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #92400e;
        }

        .billing-alert.danger {
            background: #fee2e2;
            border-color: #f87171;
            color: #991b1b;
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
        @media (max-width: 768px) {
            .sidebar {
                width: 80px;
            }

            .logo {
                font-size: 24px;
                justify-content: center;
            }

            .logo span {
                display: none;
            }

            .nav-item span {
                display: none;
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
        <div class="sidebar">
            <div class="logo">
                <span>ğŸšš</span>
                <span>çµ±åˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </span>
                <button onclick="toggleNotifications()" style="margin-left: auto; background: none; border: none; color: white; cursor: pointer; position: relative; font-size: 20px;">
                    ğŸ””
                    <span id="notification-count" style="display: none; position: absolute; top: -4px; right: -4px; background: #ef4444; color: white; font-size: 10px; font-weight: 700; padding: 2px 6px; border-radius: 10px;">0</span>
                </button>
            </div>
            <div class="nav">
                <div class="nav-item" onclick="switchModule('dashboard')">
                    <span>ğŸ“Š</span>
                    <span>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</span>
                </div>
                <div class="nav-item active" onclick="switchModule('customers')">
                    <span>ğŸ‘¥</span>
                    <span>é¡§å®¢ç®¡ç†</span>
                </div>
                <div class="nav-item" onclick="switchModule('vehicles')">
                    <span>ğŸš—</span>
                    <span>è»Šä¸¡ç®¡ç†</span>
                </div>
                <div class="nav-item" onclick="switchModule('deliveries')">
                    <span>ğŸ“¦</span>
                    <span>å®Ÿç¸¾ç®¡ç†</span>
                </div>
                <div class="nav-item" onclick="switchModule('costs')">
                    <span>ğŸ’°</span>
                    <span>åŸä¾¡è¨ˆç®—</span>
                </div>
                <div class="nav-item" onclick="switchModule('settings')">
                    <span>âš™ï¸</span>
                    <span>è¨­å®š</span>
                </div>
            </div>
        </div>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <div class="main-content" id="main-content">
            <!-- ã“ã“ã«å„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã‚‹ -->
        </div>
    </div>

    <!-- é€šçŸ¥ãƒ‘ãƒãƒ« -->
    <div class="notifications-panel" id="notifications-panel">
        <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
    </div>

    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
    <div class="loading" id="loading">
        <div class="loading-content">
            <div class="spinner"></div>
            <div id="loading-text">èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
    </div>

    <script>
        // ========================================
        // è¨­å®š
        // ========================================
        const GAS_API_URL = 'https://script.google.com/macros/s/AKfycby2Nyiq4CkFPoEmZaSbmW1Fq9t1QnQbwotXie0YnR8xBKO0czq5rVJnsWUgzfRCIrWIFw/exec';

        // ========================================
        // çŠ¶æ…‹ç®¡ç†
        // ========================================
        const state = {
            activeModule: 'customers',
            customers: [],
            containers: [],
            vehicles: [],
            selectedCustomer: null,
            selectedTab: 'basic',
            searchQuery: '',
            loading: false,
            showNotifications: false
        };

        // ========================================
        // æ¤œç´¢æ©Ÿèƒ½ï¼ˆä¿®æ­£ç‰ˆ - ãƒªã‚¹ãƒˆã®ã¿æ›´æ–°ï¼‰
        // ========================================
        let isComposing = false;  // IMEå…¥åŠ›ä¸­ãƒ•ãƒ©ã‚°

        function handleSearchInput(value) {
            // IMEå…¥åŠ›ä¸­ã¯æ¤œç´¢ã—ãªã„
            if (isComposing) {
                console.log('ğŸ” IMEå…¥åŠ›ä¸­ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—');
                return;
            }
            
            console.log('ğŸ” æ¤œç´¢å®Ÿè¡Œ:', value);
            state.searchQuery = value;
            
            // ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ¶å¾¡
            const clearBtn = document.querySelector('.search-clear-btn');
            if (clearBtn) {
                if (value) {
                    clearBtn.classList.add('show');
                } else {
                    clearBtn.classList.remove('show');
                }
            }
            
            updateCustomerListOnly();
        }

        function clearSearch() {
            console.log('ğŸ” æ¤œç´¢ã‚’ã‚¯ãƒªã‚¢');
            state.searchQuery = '';
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.value = '';
                searchInput.focus();
            }
            const clearBtn = document.querySelector('.search-clear-btn');
            if (clearBtn) {
                clearBtn.classList.remove('show');
            }
            render();
        }

        function handleSearch(value) {
            console.log('ğŸ” æ¤œç´¢å®Ÿè¡Œ:', value);
            state.searchQuery = value;
            render();
        }

        function updateCustomerListOnly() {
            // é¡§å®¢ãƒªã‚¹ãƒˆéƒ¨åˆ†ã ã‘ã‚’æ›´æ–°ï¼ˆæ¤œç´¢ãƒãƒ¼ã¯ãã®ã¾ã¾ï¼‰
            const listContainer = document.querySelector('.customer-list');
            const emptyStateContainer = document.querySelector('.empty-state');
            
            if (!listContainer && !emptyStateContainer) {
                // ãƒªã‚¹ãƒˆã‚³ãƒ³ãƒ†ãƒŠãŒå­˜åœ¨ã—ãªã„å ´åˆã¯å…¨ä½“ã‚’å†æç”»
                render();
                return;
            }

            // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            let filteredCustomers = [];
            try {
                filteredCustomers = state.customers.filter(c => {
                    if (!state.searchQuery) return true;
                    
                    try {
                        const query = String(state.searchQuery || '').toLowerCase();
                        
                        const safeStr = (val) => {
                            try {
                                return String(val || '');
                            } catch (e) {
                                return '';
                            }
                        };
                        
                        const match = (
                            safeStr(c.name).toLowerCase().includes(query) ||
                            safeStr(c.code).toLowerCase().includes(query) ||
                            safeStr(c.kana).toLowerCase().includes(query) ||
                            safeStr(c.address).toLowerCase().includes(query) ||
                            safeStr(c.notes).toLowerCase().includes(query) ||
                            safeStr(c.slipInstructions).toLowerCase().includes(query)
                        );
                        return match;
                    } catch (e) {
                        console.error('ğŸ” æ¤œç´¢ã‚¨ãƒ©ãƒ¼:', e);
                        return false;
                    }
                });
            } catch (e) {
                console.error('âŒ ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚¨ãƒ©ãƒ¼:', e);
                filteredCustomers = state.customers;
            }

            const sortedCustomers = sortCustomers(filteredCustomers);

            // æ¤œç´¢çµæœãŒ0ä»¶ã®å ´åˆ
            if (sortedCustomers.length === 0) {
                // ãƒªã‚¹ãƒˆã‚³ãƒ³ãƒ†ãƒŠã‚’ç©ºçŠ¶æ…‹ã«ç½®ãæ›ãˆ
                if (listContainer) {
                    const parent = listContainer.parentElement;
                    const emptyHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ”</div>
                            <div class="empty-state-title">æ¤œç´¢çµæœãŒã‚ã‚Šã¾ã›ã‚“</div>
                            <p>åˆ¥ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢ã—ã¦ãã ã•ã„</p>
                        </div>
                    `;
                    listContainer.outerHTML = emptyHTML;
                }
                return;
            }

            // æ¤œç´¢çµæœãŒã‚ã‚‹å ´åˆ
            const customerHTML = sortedCustomers.map(customer => `
                <div class="customer-item" onclick="selectCustomer('${customer.id}')">
                    <div class="customer-item-header">
                        <div class="customer-name">
                            <span class="customer-code">${customer.code || 'ã‚³ãƒ¼ãƒ‰ãªã—'}</span>
                            <span>${customer.name}</span>
                            ${getBadgeHtml(customer.updatedAt, customer.createdAt)}
                        </div>
                    </div>
                    <div class="customer-info">
                        <div class="customer-info-row">
                            ğŸ“ ${customer.address || 'ä½æ‰€æœªç™»éŒ²'}
                        </div>
                        <div class="customer-info-row">
                            ğŸ“ ${customer.tel || 'é›»è©±ç•ªå·æœªç™»éŒ²'}
                        </div>
                        <div class="customer-info-row">
                            ğŸ“„ å¥‘ç´„æ›¸: ${getContractCount(customer)}ä»¶
                            ğŸ“¦ ã‚³ãƒ³ãƒ†ãƒŠ: ${getCustomerContainerCount(customer.id)}å°ãƒ¬ãƒ³ã‚¿ãƒ«ä¸­
                        </div>
                    </div>
                </div>
            `).join('');

            // ãƒªã‚¹ãƒˆã‚³ãƒ³ãƒ†ãƒŠãŒã‚ã‚‹å ´åˆã¯æ›´æ–°
            if (listContainer) {
                listContainer.innerHTML = customerHTML;
            } else if (emptyStateContainer) {
                // ç©ºçŠ¶æ…‹ã‹ã‚‰å¾©å¸°
                const newListHTML = `<div class="customer-list">${customerHTML}</div>`;
                emptyStateContainer.outerHTML = newListHTML;
            }
        }

        // ========================================
        // ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½ï¼ˆä¿®æ­£ç‰ˆï¼‰
        // ========================================
        function daysDiff(dateStr) {
            if (!dateStr) return 9999;
            try {
                const d = new Date(dateStr);
                if (isNaN(d.getTime())) return 9999;
                const today = new Date();
                const diff = Math.floor((today - d) / 86400000);
                console.log(`ğŸ“… æ—¥æ•°è¨ˆç®—: ${dateStr} â†’ ${diff}æ—¥å‰`);
                return diff;
            } catch (e) {
                console.error('æ—¥ä»˜ã‚¨ãƒ©ãƒ¼:', e);
                return 9999;
            }
        }

        function freshnessRank(customer) {
            const dd = daysDiff(customer.updatedAt || customer.createdAt);
            if (dd <= 7) return 0;   // NEW
            if (dd <= 30) return 1;  // æ›´æ–°ã‚ã‚Š
            return 2;                 // é€šå¸¸
        }

        function sortCustomers(customers) {
            const sorted = customers.slice().sort((a, b) => {
                const ra = freshnessRank(a);
                const rb = freshnessRank(b);
                
                // ãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒã‚¹é †
                if (ra !== rb) return ra - rb;
                
                // ã‚³ãƒ¼ãƒ‰é †ï¼ˆæ–‡å­—åˆ—å¤‰æ›ã‚’è¿½åŠ ï¼‰
                const codeA = String(a.code || '').toLowerCase();
                const codeB = String(b.code || '').toLowerCase();
                return codeA.localeCompare(codeB, 'ja');
            });
            
            console.log('ğŸ“Š ã‚½ãƒ¼ãƒˆçµæœ:', sorted.map(c => ({
                code: c.code,
                name: c.name,
                rank: freshnessRank(c),
                days: daysDiff(c.updatedAt || c.createdAt)
            })));
            
            return sorted;
        }

        function getBadgeHtml(updatedAt, createdAt) {
            const dd = daysDiff(updatedAt || createdAt);
            if (dd <= 7) {
                return '<span style="background: #ff3b30; color: white; font-size: 12px; font-weight: 700; padding: 4px 12px; border-radius: 12px; margin-left: 8px;">NEW</span>';
            }
            if (dd <= 30) {
                return '<span style="background: #ffb020; color: white; font-size: 12px; font-weight: 700; padding: 4px 12px; border-radius: 12px; margin-left: 8px;">æ›´æ–°ã‚ã‚Š</span>';
            }
            return '';
        }

        // ========================================
        // é€šçŸ¥æ©Ÿèƒ½
        // ========================================
        function toggleNotifications() {
            state.showNotifications = !state.showNotifications;
            renderNotifications();
        }

        function renderNotifications() {
            const panel = document.getElementById('notifications-panel');
            const notifications = getContainerBillingNotifications();
            
            if (state.showNotifications) {
                panel.classList.add('show');
                
                if (notifications.length === 0) {
                    panel.innerHTML = `
                        <div class="notifications-header">
                            é€šçŸ¥
                            <button class="close-btn" onclick="toggleNotifications()">âœ•</button>
                        </div>
                        <div style="padding: 40px; text-align: center; color: #64748b;">
                            <p>é€šçŸ¥ã¯ã‚ã‚Šã¾ã›ã‚“</p>
                        </div>
                    `;
                } else {
                    panel.innerHTML = `
                        <div class="notifications-header">
                            é€šçŸ¥ (${notifications.length})
                            <button class="close-btn" onclick="toggleNotifications()">âœ•</button>
                        </div>
                        <div class="notifications-list">
                            ${notifications.map(n => `
                                <div class="notification-item ${n.type}" onclick="selectCustomer('${n.customerId}'); state.selectedTab = 'containers'; state.showNotifications = false; renderNotifications(); render();">
                                    <div class="notification-title">${n.title}</div>
                                    <div class="notification-text">${n.text}</div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            } else {
                panel.classList.remove('show');
            }
            
            // é€šçŸ¥ã‚«ã‚¦ãƒ³ãƒˆã‚’æ›´æ–°
            const countBadge = document.getElementById('notification-count');
            if (notifications.length > 0) {
                countBadge.textContent = notifications.length;
                countBadge.style.display = 'block';
            } else {
                countBadge.style.display = 'none';
            }
        }

        function getContainerBillingNotifications() {
            const notifications = [];
            const today = new Date();
            
            state.containers
                .filter(c => c.status === 'ãƒ¬ãƒ³ã‚¿ãƒ«ä¸­' && c.nextBillingDate)
                .forEach(container => {
                    const billingDate = new Date(container.nextBillingDate);
                    const daysUntil = Math.ceil((billingDate - today) / (24 * 60 * 60 * 1000));
                    
                    if (daysUntil <= 30 && daysUntil > 0) {
                        notifications.push({
                            type: 'warning',
                            title: `ã‚³ãƒ³ãƒ†ãƒŠè«‹æ±‚æ—¥ãŒè¿‘ã¥ã„ã¦ã„ã¾ã™`,
                            text: `${container.customerName} (${container.containerNumber}) ã®è«‹æ±‚æ—¥ã¾ã§æ®‹ã‚Š${daysUntil}æ—¥ã§ã™`,
                            customerId: container.customerId,
                            containerId: container.id,
                            daysUntil: daysUntil
                        });
                    } else if (daysUntil <= 0) {
                        notifications.push({
                            type: 'danger',
                            title: `ã‚³ãƒ³ãƒ†ãƒŠè«‹æ±‚æ—¥ã‚’éãã¦ã„ã¾ã™`,
                            text: `${container.customerName} (${container.containerNumber}) ã®è«‹æ±‚å‡¦ç†ã‚’è¡Œã£ã¦ãã ã•ã„`,
                            customerId: container.customerId,
                            containerId: container.id,
                            daysUntil: daysUntil
                        });
                    }
                });
            
            return notifications.sort((a, b) => a.daysUntil - b.daysUntil);
        }

        // ========================================
        // åˆæœŸåŒ–
        // ========================================
        async function init() {
            console.log('ğŸš€ çµ±åˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  Pro v2.3 - æ¤œç´¢å®Œå…¨ä¿®æ­£ç‰ˆ');
            console.log('ğŸ“… ãƒ“ãƒ«ãƒ‰æ—¥æ™‚: 2026-02-06 00:45');
            console.log('âœ… String()å¤‰æ›: æœ‰åŠ¹');
            console.log('âœ… try-catchä¿è­·: æœ‰åŠ¹');
            console.log('âœ… æ¤œç´¢ãƒãƒ¼ä¿®æ­£: è¤‡æ•°æ–‡å­—å…¥åŠ›å¯èƒ½');
            console.log('âœ… IMEå¯¾å¿œ: æ—¥æœ¬èªå…¥åŠ›å¯¾å¿œ');
            console.log('âœ… æ¤œç´¢ã‚¯ãƒªã‚¢: âœ•ãƒœã‚¿ãƒ³è¿½åŠ ');
            
            showLoading('ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...');
            try {
                await loadAllData();
                renderNotifications();
                render();
                console.log('âœ… åˆæœŸåŒ–å®Œäº†');
            } catch (error) {
                console.error('âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // ========================================
        // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆä¿®æ­£ç‰ˆï¼‰
        // ========================================
        async function loadAllData() {
            return new Promise((resolve, reject) => {
                const callbackName = 'jsonpCallback' + Date.now();
                
                window[callbackName] = function(response) {
                    delete window[callbackName];
                    
                    if (response.success) {
                        // updatedAtãŒãªã„å ´åˆã¯è£œå®Œ + ãƒ‡ãƒ¼ã‚¿å‹ã‚’æ­£è¦åŒ–
                        state.customers = (response.data.customers || []).map(c => ({
                            ...c,
                            // æ–‡å­—åˆ—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ­£è¦åŒ–
                            code: String(c.code || ''),
                            name: String(c.name || ''),
                            kana: String(c.kana || ''),
                            type: String(c.type || ''),
                            address: String(c.address || ''),
                            tel: String(c.tel || ''),
                            fax: String(c.fax || ''),
                            email: String(c.email || ''),
                            contactPerson: String(c.contactPerson || ''),
                            collectionDay: String(c.collectionDay || ''),
                            notes: String(c.notes || ''),
                            slipInstructions: String(c.slipInstructions || ''),
                            contracts: String(c.contracts || '[]'),
                            images: String(c.images || '[]'),
                            // updatedAtã‚’è£œå®Œ
                            updatedAt: c.updatedAt || c.createdAt || new Date().toISOString()
                        }));
                        state.containers = response.data.containers || [];
                        state.vehicles = response.data.vehicles || [];
                        
                        console.log('âœ… ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿æˆåŠŸ:', {
                            customers: state.customers.length,
                            containers: state.containers.length,
                            vehicles: state.vehicles.length
                        });
                        
                        // ã‚µãƒ³ãƒ—ãƒ«è¡¨ç¤º
                        if (state.customers.length > 0) {
                            console.log('ğŸ“‹ é¡§å®¢ã‚µãƒ³ãƒ—ãƒ«:', state.customers.slice(0, 3).map(c => ({
                                code: c.code,
                                codeType: typeof c.code,
                                name: c.name,
                                updatedAt: c.updatedAt,
                                days: daysDiff(c.updatedAt)
                            })));
                        }
                        
                        resolve(response.data);
                    } else {
                        reject(new Error(response.error || 'ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼'));
                    }
                };
                
                const script = document.createElement('script');
                script.src = `${GAS_API_URL}?action=getAllSheets&callback=${callbackName}`;
                script.onerror = () => reject(new Error('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼'));
                document.body.appendChild(script);
            });
        }

        // ========================================
        // GAS APIå‘¼ã³å‡ºã—
        // ========================================
        async function gasPost(action, sheet, data) {
            return new Promise((resolve, reject) => {
                const callbackName = 'jsonpCallback' + Date.now();
                
                window[callbackName] = function(response) {
                    delete window[callbackName];
                    
                    if (response.success) {
                        resolve(response);
                    } else {
                        reject(new Error(response.error || 'APIå‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼'));
                    }
                };
                
                const params = new URLSearchParams({
                    action: action,
                    sheet: sheet,
                    data: encodeURIComponent(JSON.stringify(data)),
                    callback: callbackName
                });
                
                const script = document.createElement('script');
                script.src = `${GAS_API_URL}?${params.toString()}`;
                script.onerror = () => reject(new Error('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼'));
                document.body.appendChild(script);
            });
        }

        // ========================================
        // ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åˆ‡ã‚Šæ›¿ãˆ
        // ========================================
        function switchModule(moduleName) {
            state.activeModule = moduleName;
            state.selectedCustomer = null; // é‡è¦ï¼šé¡§å®¢è©³ç´°ã‚’ã‚¯ãƒªã‚¢
            
            // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã® active çŠ¶æ…‹ã‚’æ›´æ–°
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
            
            render();
        }

        // ========================================
        // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        // ========================================
        function render() {
            const content = document.getElementById('main-content');
            
            try {
                switch (state.activeModule) {
                    case 'dashboard':
                        content.innerHTML = renderDashboard();
                        break;
                    case 'customers':
                        content.innerHTML = renderCustomers();
                        break;
                    case 'vehicles':
                        content.innerHTML = '<div class="content"><h2>ğŸš— è»Šä¸¡ç®¡ç†ã¯é–‹ç™ºä¸­...</h2></div>';
                        break;
                    case 'deliveries':
                        content.innerHTML = '<div class="content"><h2>ğŸ“¦ å®Ÿç¸¾ç®¡ç†ã¯é–‹ç™ºä¸­...</h2></div>';
                        break;
                    case 'costs':
                        content.innerHTML = '<div class="content"><h2>ğŸ’° åŸä¾¡è¨ˆç®—ã¯é–‹ç™ºä¸­...</h2></div>';
                        break;
                    case 'settings':
                        content.innerHTML = '<div class="content"><h2>âš™ï¸ è¨­å®šã¯é–‹ç™ºä¸­...</h2></div>';
                        break;
                    default:
                        content.innerHTML = renderCustomers();
                }
                
                renderNotifications();
            } catch (error) {
                console.error('âŒ ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚¨ãƒ©ãƒ¼:', error);
                content.innerHTML = `<div class="content"><h2>ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h2><p>${error.message}</p></div>`;
            }
        }

        // ========================================
        // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
        // ========================================
        function renderDashboard() {
            const totalCustomers = state.customers.length;
            const totalContainers = state.containers.length;
            const rentingContainers = state.containers.filter(c => c.status === 'ãƒ¬ãƒ³ã‚¿ãƒ«ä¸­').length;
            
            return `
                <div class="header">
                    <div class="header-title">ğŸ“Š ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</div>
                </div>
                <div class="content">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 32px;">
                        <div class="card">
                            <div style="font-size: 14px; color: #64748b; margin-bottom: 8px;">ç™»éŒ²é¡§å®¢æ•°</div>
                            <div style="font-size: 32px; font-weight: 700; color: #1e293b;">${totalCustomers}</div>
                            <div style="font-size: 12px; color: #64748b; margin-top: 4px;">ç¤¾</div>
                        </div>
                        <div class="card">
                            <div style="font-size: 14px; color: #64748b; margin-bottom: 8px;">ã‚³ãƒ³ãƒ†ãƒŠä¿æœ‰æ•°</div>
                            <div style="font-size: 32px; font-weight: 700; color: #1e293b;">${totalContainers}</div>
                            <div style="font-size: 12px; color: #64748b; margin-top: 4px;">å°</div>
                        </div>
                        <div class="card">
                            <div style="font-size: 14px; color: #64748b; margin-bottom: 8px;">ãƒ¬ãƒ³ã‚¿ãƒ«ä¸­</div>
                            <div style="font-size: 32px; font-weight: 700; color: #3b82f6;">${rentingContainers}</div>
                            <div style="font-size: 12px; color: #64748b; margin-top: 4px;">å°</div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3>ğŸ‰ çµ±åˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã¸ã‚ˆã†ã“ãï¼</h3>
                        <p style="color: #64748b; margin-top: 12px;">é¡§å®¢ç®¡ç†ã¨ã‚³ãƒ³ãƒ†ãƒŠç®¡ç†ã®æº–å‚™ãŒæ•´ã„ã¾ã—ãŸã€‚</p>
                        <p style="color: #64748b; margin-top: 8px;">å·¦ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã€ŒğŸ‘¥ é¡§å®¢ç®¡ç†ã€ã‚’é¸æŠã—ã¦ã€é¡§å®¢æƒ…å ±ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚</p>
                    </div>
                </div>
            `;
        }

        // ========================================
        // é¡§å®¢ç®¡ç†
        // ========================================
        function renderCustomers() {
            if (state.selectedCustomer) {
                return renderCustomerDetail();
            }
            
            return renderCustomerList();
        }

        function renderCustomerList() {
            console.log('ğŸ“‹ é¡§å®¢ä¸€è¦§ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°é–‹å§‹');
            
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆå®Œå…¨ã‚¨ãƒ©ãƒ¼ã‚»ãƒ¼ãƒ•ç‰ˆï¼‰
            let filteredCustomers = [];
            try {
                filteredCustomers = state.customers.filter(c => {
                    if (!state.searchQuery) return true;
                    
                    try {
                        const query = String(state.searchQuery || '').toLowerCase();
                        
                        // å®‰å…¨ãªæ–‡å­—åˆ—å¤‰æ›é–¢æ•°
                        const safeStr = (val) => {
                            try {
                                return String(val || '');
                            } catch (e) {
                                return '';
                            }
                        };
                        
                        const match = (
                            safeStr(c.name).toLowerCase().includes(query) ||
                            safeStr(c.code).toLowerCase().includes(query) ||
                            safeStr(c.kana).toLowerCase().includes(query) ||
                            safeStr(c.address).toLowerCase().includes(query) ||
                            safeStr(c.notes).toLowerCase().includes(query) ||
                            safeStr(c.slipInstructions).toLowerCase().includes(query)
                        );
                        return match;
                    } catch (e) {
                        console.error('ğŸ” æ¤œç´¢ã‚¨ãƒ©ãƒ¼ï¼ˆé¡§å®¢ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼‰:', c.id, e);
                        return false;
                    }
                });
            } catch (e) {
                console.error('âŒ ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å…¨ä½“ã‚¨ãƒ©ãƒ¼:', e);
                filteredCustomers = state.customers;
            }
            
            console.log('ğŸ” ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°:', {
                å…ƒã®ä»¶æ•°: state.customers.length,
                çµã‚Šè¾¼ã¿å¾Œ: filteredCustomers.length,
                ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: state.searchQuery
            });
            
            // ã‚½ãƒ¼ãƒˆ
            const sortedCustomers = sortCustomers(filteredCustomers);
            
            return `
                <div class="header">
                    <div class="header-title">ğŸ‘¥ é¡§å®¢ç®¡ç†</div>
                    <div class="header-actions">
                        <button class="btn btn-secondary" onclick="exportCustomersCSV()">
                            ğŸ“¥ CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                        </button>
                        <button class="btn btn-secondary" onclick="importCustomersCSV()">
                            ğŸ“¤ CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                        </button>
                        <button class="btn btn-primary" onclick="openCustomerForm()">
                            â• æ–°è¦é¡§å®¢ã‚’è¿½åŠ 
                        </button>
                    </div>
                </div>
                <div class="content">
                    <div class="search-bar">
                        <input type="text" 
                               id="search-input"
                               placeholder="é¡§å®¢åã€ã‚³ãƒ¼ãƒ‰ã€ä½æ‰€ã€æ³¨æ„äº‹é …ã§æ¤œç´¢..." 
                               value="${state.searchQuery}"
                               oninput="handleSearchInput(this.value)"
                               oncompositionstart="isComposing = true"
                               oncompositionend="isComposing = false; handleSearchInput(this.value)">
                        <button class="search-clear-btn ${state.searchQuery ? 'show' : ''}" 
                                onclick="clearSearch()"
                                title="æ¤œç´¢ã‚’ã‚¯ãƒªã‚¢">âœ•</button>
                    </div>
                    
                    ${sortedCustomers.length === 0 ? `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ‘¥</div>
                            <div class="empty-state-title">${state.searchQuery ? 'æ¤œç´¢çµæœãŒã‚ã‚Šã¾ã›ã‚“' : 'é¡§å®¢ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“'}</div>
                            <p>${state.searchQuery ? 'åˆ¥ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢ã—ã¦ãã ã•ã„' : 'ã€Œæ–°è¦é¡§å®¢ã‚’è¿½åŠ ã€ãƒœã‚¿ãƒ³ã‹ã‚‰ç™»éŒ²ã‚’é–‹å§‹ã—ã¦ãã ã•ã„'}</p>
                        </div>
                    ` : `
                        <div class="customer-list">
                            ${sortedCustomers.map(customer => `
                                <div class="customer-item" onclick="selectCustomer('${customer.id}')">
                                    <div class="customer-item-header">
                                        <div class="customer-name">
                                            <span class="customer-code">${customer.code || 'ã‚³ãƒ¼ãƒ‰ãªã—'}</span>
                                            <span>${customer.name}</span>
                                            ${getBadgeHtml(customer.updatedAt, customer.createdAt)}
                                        </div>
                                    </div>
                                    <div class="customer-info">
                                        <div class="customer-info-row">
                                            ğŸ“ ${customer.address || 'ä½æ‰€æœªç™»éŒ²'}
                                        </div>
                                        <div class="customer-info-row">
                                            ğŸ“ ${customer.tel || 'é›»è©±ç•ªå·æœªç™»éŒ²'}
                                        </div>
                                        <div class="customer-info-row">
                                            ğŸ“„ å¥‘ç´„æ›¸: ${getContractCount(customer)}ä»¶
                                            ğŸ“¦ ã‚³ãƒ³ãƒ†ãƒŠ: ${getCustomerContainerCount(customer.id)}å°ãƒ¬ãƒ³ã‚¿ãƒ«ä¸­
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `}
                </div>
            `;
        }

        function renderCustomerDetail() {
            const customer = state.selectedCustomer;
            const containers = getCustomerContainers(customer.id);
            
            return `
                <div class="header">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <button class="btn btn-secondary" onclick="backToCustomerList()">
                            â† æˆ»ã‚‹
                        </button>
                        <div>
                            <div style="font-size: 12px; color: #64748b; margin-bottom: 4px;">
                                ${customer.code || 'ã‚³ãƒ¼ãƒ‰ãªã—'}
                            </div>
                            <div class="header-title">${customer.name}</div>
                        </div>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-secondary" onclick="editCustomer('${customer.id}')">
                            âœï¸ ç·¨é›†
                        </button>
                        <button class="btn btn-danger" onclick="deleteCustomer('${customer.id}')">
                            ğŸ—‘ï¸ å‰Šé™¤
                        </button>
                    </div>
                </div>
                <div class="content">
                    <div class="tabs">
                        <div class="tab ${state.selectedTab === 'basic' ? 'active' : ''}" 
                             onclick="switchTab('basic')">
                            åŸºæœ¬æƒ…å ±
                        </div>
                        <div class="tab ${state.selectedTab === 'contracts' ? 'active' : ''}" 
                             onclick="switchTab('contracts')">
                            å¥‘ç´„æ›¸
                        </div>
                        <div class="tab ${state.selectedTab === 'notes' ? 'active' : ''}" 
                             onclick="switchTab('notes')">
                            æ³¨æ„äº‹é …
                        </div>
                        <div class="tab ${state.selectedTab === 'containers' ? 'active' : ''}" 
                             onclick="switchTab('containers')">
                            ã‚³ãƒ³ãƒ†ãƒŠ (${containers.length})
                        </div>
                    </div>
                    
                    ${renderCustomerTab(customer)}
                </div>
            `;
        }

        function backToCustomerList() {
            state.selectedCustomer = null;
            render();
        }

        function switchTab(tabName) {
            state.selectedTab = tabName;
            render();
        }

        function renderCustomerTab(customer) {
            switch (state.selectedTab) {
                case 'basic':
                    return renderBasicTab(customer);
                case 'contracts':
                    return renderContractsTab(customer);
                case 'notes':
                    return renderNotesTab(customer);
                case 'containers':
                    return renderContainersTab(customer);
                default:
                    return renderBasicTab(customer);
            }
        }

        function renderBasicTab(customer) {
            return `
                <div class="card">
                    <h3 style="margin-bottom: 20px;">åŸºæœ¬æƒ…å ±</h3>
                    <div style="display: grid; gap: 16px;">
                        <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px; padding: 12px 0; border-bottom: 1px solid #e2e8f0;">
                            <div style="color: #64748b; font-size: 14px;">è«‹æ±‚ã‚³ãƒ¼ãƒ‰</div>
                            <div style="font-weight: 600;">${customer.code || '-'}</div>
                        </div>
                        <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px; padding: 12px 0; border-bottom: 1px solid #e2e8f0;">
                            <div style="color: #64748b; font-size: 14px;">äº‹æ¥­æ‰€å</div>
                            <div style="font-weight: 600;">${customer.name}</div>
                        </div>
                        <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px; padding: 12px 0; border-bottom: 1px solid #e2e8f0;">
                            <div style="color: #64748b; font-size: 14px;">ãƒ•ãƒªã‚¬ãƒŠ</div>
                            <div>${customer.kana || '-'}</div>
                        </div>
                        <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px; padding: 12px 0; border-bottom: 1px solid #e2e8f0;">
                            <div style="color: #64748b; font-size: 14px;">æ¥­ç¨®</div>
                            <div>${customer.type || '-'}</div>
                        </div>
                        <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px; padding: 12px 0; border-bottom: 1px solid #e2e8f0;">
                            <div style="color: #64748b; font-size: 14px;">ä½æ‰€</div>
                            <div>${customer.address || '-'}</div>
                        </div>
                        <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px; padding: 12px 0; border-bottom: 1px solid #e2e8f0;">
                            <div style="color: #64748b; font-size: 14px;">é›»è©±ç•ªå·</div>
                            <div>${customer.tel || '-'}</div>
                        </div>
                        <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px; padding: 12px 0; border-bottom: 1px solid #e2e8f0;">
                            <div style="color: #64748b; font-size: 14px;">FAX</div>
                            <div>${customer.fax || '-'}</div>
                        </div>
                        <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px; padding: 12px 0; border-bottom: 1px solid #e2e8f0;">
                            <div style="color: #64748b; font-size: 14px;">ãƒ¡ãƒ¼ãƒ«</div>
                            <div>${customer.email || '-'}</div>
                        </div>
                        <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px; padding: 12px 0; border-bottom: 1px solid #e2e8f0;">
                            <div style="color: #64748b; font-size: 14px;">æ‹…å½“è€…</div>
                            <div>${customer.contactPerson || '-'}</div>
                        </div>
                        <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px; padding: 12px 0;">
                            <div style="color: #64748b; font-size: 14px;">å›åæ›œæ—¥</div>
                            <div>${customer.collectionDay || '-'}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderContractsTab(customer) {
            const contracts = parseJSON(customer.contracts) || [];
            
            return `
                <div class="card">
                    <div class="card-header">
                        <h3>å¥‘ç´„æ›¸ä¸€è¦§</h3>
                        <button class="btn btn-primary" onclick="openContractForm('${customer.id}')">
                            â• å¥‘ç´„æ›¸ã‚’è¿½åŠ 
                        </button>
                    </div>
                    
                    ${contracts.length === 0 ? `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“„</div>
                            <div class="empty-state-title">å¥‘ç´„æ›¸ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>
                        </div>
                    ` : `
                        <div style="display: grid; gap: 12px;">
                            ${contracts.map(contract => `
                                <div class="container-item">
                                    <div style="display: flex; justify-content: space-between; align-items: start;">
                                        <div>
                                            <div style="font-weight: 700; margin-bottom: 8px;">ğŸ“„ ${contract.name}</div>
                                            ${contract.startDate ? `<div style="font-size: 13px; color: #64748b;">å¥‘ç´„æ—¥: ${contract.startDate}</div>` : ''}
                                            ${contract.endDate ? `<div style="font-size: 13px; color: #64748b;">æœ‰åŠ¹æœŸé™: ${contract.endDate}</div>` : ''}
                                            ${contract.notes ? `<div style="font-size: 13px; color: #64748b; margin-top: 4px;">${contract.notes}</div>` : ''}
                                        </div>
                                        <div style="display: flex; gap: 8px;">
                                            ${contract.url ? `<a href="${contract.url}" target="_blank" class="btn btn-secondary" style="text-decoration: none;">ğŸ“„ é–‹ã</a>` : ''}
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `}
                </div>
            `;
        }

        function renderNotesTab(customer) {
            const images = parseJSON(customer.images) || [];
            
            return `
                <div class="card">
                    <div class="card-header">
                        <h3>å›åæ™‚ã®æ³¨æ„äº‹é …</h3>
                        <button class="btn btn-secondary" onclick="editNotes('${customer.id}', 'notes')">
                            âœï¸ ç·¨é›†
                        </button>
                    </div>
                    <div style="background: #f8fafc; padding: 16px; border-radius: 8px; white-space: pre-wrap; text-align: left;">
                        ${customer.notes || 'æ³¨æ„äº‹é …ã¯ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“'}
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3>ä¼ç¥¨ã®æ›¸ãæ–¹</h3>
                        <button class="btn btn-secondary" onclick="editNotes('${customer.id}', 'slipInstructions')">
                            âœï¸ ç·¨é›†
                        </button>
                    </div>
                    <div style="background: #f8fafc; padding: 16px; border-radius: 8px; white-space: pre-wrap; text-align: left;">
                        ${customer.slipInstructions || 'ä¼ç¥¨ã®æ›¸ãæ–¹ã¯ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“'}
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3>å‚è€ƒç”»åƒ</h3>
                        <button class="btn btn-primary" onclick="openImageForm('${customer.id}')">
                            â• ç”»åƒã‚’è¿½åŠ 
                        </button>
                    </div>
                    ${images.length === 0 ? `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ–¼ï¸</div>
                            <div class="empty-state-title">ç”»åƒãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>
                        </div>
                    ` : `
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px;">
                            ${images.map(img => `
                                <div>
                                    <a href="${img.url}" target="_blank">
                                        <img src="${convertDriveUrl(img.url)}" 
                                             alt="${img.name}"
                                             style="width: 100%; height: 150px; object-fit: cover; border-radius: 8px; border: 1px solid #e2e8f0;">
                                    </a>
                                    <div style="margin-top: 8px; font-size: 13px; font-weight: 600;">${img.name}</div>
                                    ${img.description ? `<div style="font-size: 12px; color: #64748b;">${img.description}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    `}
                </div>
            `;
        }

        function renderContainersTab(customer) {
            const containers = getCustomerContainers(customer.id);
            
            return `
                <div class="card">
                    <div class="card-header">
                        <div>
                            <h3>ã‚³ãƒ³ãƒ†ãƒŠãƒ¬ãƒ³ã‚¿ãƒ«çŠ¶æ³</h3>
                            <div style="font-size: 14px; color: #64748b; margin-top: 4px;">
                                ğŸ“¦ ãƒ¬ãƒ³ã‚¿ãƒ«ä¸­: ${containers.length}å°
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="openContainerForm('${customer.id}')">
                            â• ã‚³ãƒ³ãƒ†ãƒŠã‚’è¿½åŠ 
                        </button>
                    </div>
                    
                    ${containers.length === 0 ? `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“¦</div>
                            <div class="empty-state-title">ãƒ¬ãƒ³ã‚¿ãƒ«ä¸­ã®ã‚³ãƒ³ãƒ†ãƒŠã¯ã‚ã‚Šã¾ã›ã‚“</div>
                        </div>
                    ` : `
                        <div style="display: grid; gap: 12px;">
                            ${containers.map(container => renderContainerItem(container)).join('')}
                        </div>
                    `}
                </div>
            `;
        }

        function renderContainerItem(container) {
            const daysUntil = daysUntilBilling(container.nextBillingDate);
            
            return `
                <div class="container-item">
                    <div class="container-item-header">
                        <div class="container-type">ğŸ“¦ ${container.containerNumber} ${container.type}</div>
                        <div class="container-status ${container.status === 'ãƒ¬ãƒ³ã‚¿ãƒ«ä¸­' ? 'renting' : 'available'}">
                            ${container.status}
                        </div>
                    </div>
                    <div class="container-info">
                        <div>è²¸å‡ºæ—¥: ${formatDate(container.rentalStartDate)}</div>
                        ${container.location ? `<div>è¨­ç½®å ´æ‰€: ${container.location}</div>` : ''}
                        <div>ãƒ¬ãƒ³ã‚¿ãƒ«æ–™: Â¥${(container.rentalFee || 0).toLocaleString()}/${container.billingCycle || 'å¹´'}</div>
                        ${container.nextBillingDate ? `
                            <div>ğŸ“… è«‹æ±‚æ—¥: ${formatDate(container.nextBillingDate)}</div>
                            ${daysUntil !== null ? `
                                <div class="billing-alert ${daysUntil <= 0 ? 'danger' : ''}">
                                    ${daysUntil <= 0 ? 'âš ï¸ è«‹æ±‚æœŸé™ã‚’éãã¦ã„ã¾ã™' : `â° ã‚ã¨${daysUntil}æ—¥`}
                                </div>
                            ` : ''}
                        ` : ''}
                    </div>
                    <div class="container-actions">
                        ${container.nextBillingDate && daysUntil <= 30 ? `
                            <button class="btn btn-primary" onclick="completeBilling('${container.id}')">
                                âœ… è«‹æ±‚å®Œäº†
                            </button>
                        ` : ''}
                        <button class="btn btn-secondary" onclick="editContainer('${container.id}')">
                            âœï¸ ç·¨é›†
                        </button>
                        <button class="btn btn-secondary" onclick="returnContainer('${container.id}')">
                            â†©ï¸ è¿”å´
                        </button>
                        <button class="btn btn-danger" onclick="deleteContainer('${container.id}')">
                            ğŸ—‘ï¸ å‰Šé™¤
                        </button>
                    </div>
                </div>
            `;
        }

        // ========================================
        // é¡§å®¢ãƒ•ã‚©ãƒ¼ãƒ 
        // ========================================
        function openCustomerForm(customerId = null) {
            const customer = customerId ? state.customers.find(c => c.id === customerId) : null;
            const isEdit = !!customer;
            
            const modalHTML = `
                <div class="modal show" id="customer-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title">${isEdit ? 'é¡§å®¢æƒ…å ±ã‚’ç·¨é›†' : 'æ–°è¦é¡§å®¢ã‚’è¿½åŠ '}</h3>
                            <button class="close-btn" onclick="closeModal('customer-modal')">âœ•</button>
                        </div>
                        <div class="modal-body">
                            <form id="customer-form" onsubmit="submitCustomerForm(event)">
                                <input type="hidden" name="id" value="${customer?.id || ''}">
                                
                                <h4 style="margin-bottom: 16px;">åŸºæœ¬æƒ…å ±</h4>
                                
                                <div class="form-group">
                                    <label>è«‹æ±‚ã‚³ãƒ¼ãƒ‰ *</label>
                                    <input type="text" name="code" value="${customer?.code || ''}" placeholder="ä¾‹: A-001" required>
                                    <small>è«‹æ±‚æ›¸ã§ä½¿ç”¨ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã§ã™</small>
                                </div>
                                
                                <div class="form-group">
                                    <label>äº‹æ¥­æ‰€å *</label>
                                    <input type="text" name="name" value="${customer?.name || ''}" required>
                                </div>
                                
                                <div class="form-group">
                                    <label>ãƒ•ãƒªã‚¬ãƒŠ *</label>
                                    <input type="text" name="kana" value="${customer?.kana || ''}" required>
                                </div>
                                
                                <div class="form-group">
                                    <label>æ¥­ç¨®</label>
                                    <select name="type">
                                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                        <option value="å»ºè¨­æ¥­" ${customer?.type === 'å»ºè¨­æ¥­' ? 'selected' : ''}>å»ºè¨­æ¥­</option>
                                        <option value="å°å£²æ¥­" ${customer?.type === 'å°å£²æ¥­' ? 'selected' : ''}>å°å£²æ¥­</option>
                                        <option value="é£²é£Ÿæ¥­" ${customer?.type === 'é£²é£Ÿæ¥­' ? 'selected' : ''}>é£²é£Ÿæ¥­</option>
                                        <option value="è£½é€ æ¥­" ${customer?.type === 'è£½é€ æ¥­' ? 'selected' : ''}>è£½é€ æ¥­</option>
                                        <option value="ã‚ªãƒ•ã‚£ã‚¹" ${customer?.type === 'ã‚ªãƒ•ã‚£ã‚¹' ? 'selected' : ''}>ã‚ªãƒ•ã‚£ã‚¹</option>
                                        <option value="åŒ»ç™‚æ©Ÿé–¢" ${customer?.type === 'åŒ»ç™‚æ©Ÿé–¢' ? 'selected' : ''}>åŒ»ç™‚æ©Ÿé–¢</option>
                                        <option value="ãã®ä»–" ${customer?.type === 'ãã®ä»–' ? 'selected' : ''}>ãã®ä»–</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>ä½æ‰€ *</label>
                                    <input type="text" name="address" value="${customer?.address || ''}" required>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>é›»è©±ç•ªå· *</label>
                                        <input type="tel" name="tel" value="${customer?.tel || ''}" required>
                                    </div>
                                    <div class="form-group">
                                        <label>FAX</label>
                                        <input type="tel" name="fax" value="${customer?.fax || ''}">
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                                    <input type="email" name="email" value="${customer?.email || ''}">
                                </div>
                                
                                <div class="form-group">
                                    <label>æ‹…å½“è€…å</label>
                                    <input type="text" name="contactPerson" value="${customer?.contactPerson || ''}">
                                </div>
                                
                                <div class="form-group">
                                    <label>å›åæ›œæ—¥</label>
                                    <input type="text" name="collectionDay" value="${customer?.collectionDay || ''}" placeholder="ä¾‹: æœˆãƒ»æ°´ãƒ»é‡‘">
                                </div>
                                
                                <hr style="margin: 24px 0;">
                                
                                <h4 style="margin-bottom: 16px;">æ³¨æ„äº‹é …</h4>
                                
                                <div class="form-group">
                                    <label>å›åæ™‚ã®æ³¨æ„äº‹é …</label>
                                    <textarea name="notes" rows="4" placeholder="å›åæ™‚ã®æ³¨æ„ç‚¹ã‚’è¨˜å…¥">${customer?.notes || ''}</textarea>
                                </div>
                                
                                <div class="form-group">
                                    <label>ä¼ç¥¨ã®æ›¸ãæ–¹</label>
                                    <textarea name="slipInstructions" rows="4" placeholder="ä¼ç¥¨è¨˜å…¥æ–¹æ³•ã‚’è¨˜å…¥">${customer?.slipInstructions || ''}</textarea>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="closeModal('customer-modal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                            <button type="submit" form="customer-form" class="btn btn-primary">ä¿å­˜</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        async function submitCustomerForm(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData.entries());
            
            try {
                showLoading('ä¿å­˜ä¸­...');
                
                // æ—¢å­˜ã®é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const existingCustomer = data.id ? state.customers.find(c => c.id === data.id) : null;
                
                const customer = {
                    id: data.id || `c${Date.now()}`,
                    code: data.code,
                    name: data.name,
                    kana: data.kana,
                    type: data.type,
                    address: data.address,
                    tel: data.tel,
                    fax: data.fax,
                    email: data.email,
                    contactPerson: data.contactPerson,
                    collectionDay: data.collectionDay,
                    notes: data.notes,
                    slipInstructions: data.slipInstructions,
                    // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ
                    contracts: existingCustomer ? existingCustomer.contracts : '[]',
                    images: existingCustomer ? existingCustomer.images : '[]',
                    createdAt: existingCustomer ? existingCustomer.createdAt : new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                console.log('ğŸ’¾ ä¿å­˜ãƒ‡ãƒ¼ã‚¿:', customer);
                
                const action = data.id ? 'update' : 'add';
                await gasPost(action, 'customers', customer);
                
                if (action === 'update') {
                    const index = state.customers.findIndex(c => c.id === customer.id);
                    state.customers[index] = customer;
                    if (state.selectedCustomer?.id === customer.id) {
                        state.selectedCustomer = customer;
                    }
                } else {
                    state.customers.push(customer);
                }
                
                closeModal('customer-modal');
                hideLoading();
                alert('âœ… ä¿å­˜ã—ã¾ã—ãŸï¼');
                render();
                
            } catch (error) {
                console.error('âŒ ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                hideLoading();
            }
        }

        function editCustomer(customerId) {
            openCustomerForm(customerId);
        }

        async function deleteCustomer(customerId) {
            if (!confirm('ã“ã®é¡§å®¢ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nãƒ¬ãƒ³ã‚¿ãƒ«ä¸­ã®ã‚³ãƒ³ãƒ†ãƒŠãŒã‚ã‚‹å ´åˆã¯å‰Šé™¤ã§ãã¾ã›ã‚“ã€‚')) return;
            
            // ãƒ¬ãƒ³ã‚¿ãƒ«ä¸­ã®ã‚³ãƒ³ãƒ†ãƒŠãƒã‚§ãƒƒã‚¯
            const containers = getCustomerContainers(customerId);
            if (containers.length > 0) {
                alert('âš ï¸ ãƒ¬ãƒ³ã‚¿ãƒ«ä¸­ã®ã‚³ãƒ³ãƒ†ãƒŠãŒã‚ã‚‹ãŸã‚å‰Šé™¤ã§ãã¾ã›ã‚“ã€‚\nå…ˆã«ã‚³ãƒ³ãƒ†ãƒŠã‚’è¿”å´ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            try {
                showLoading('å‰Šé™¤ä¸­...');
                
                await gasPost('delete', 'customers', { id: customerId });
                state.customers = state.customers.filter(c => c.id !== customerId);
                state.selectedCustomer = null;
                
                hideLoading();
                alert('âœ… å‰Šé™¤ã—ã¾ã—ãŸ');
                render();
                
            } catch (error) {
                console.error('âŒ å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                hideLoading();
            }
        }

        function selectCustomer(customerId) {
            state.selectedCustomer = state.customers.find(c => c.id === customerId);
            state.selectedTab = 'basic';
            render();
        }

        // ========================================
        // ã‚³ãƒ³ãƒ†ãƒŠãƒ•ã‚©ãƒ¼ãƒ 
        // ========================================
        function openContainerForm(customerId, containerId = null) {
            const container = containerId ? state.containers.find(c => c.id === containerId) : null;
            const customer = state.customers.find(c => c.id === customerId);
            const isEdit = !!container;
            
            const modalHTML = `
                <div class="modal show" id="container-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title">${isEdit ? 'ã‚³ãƒ³ãƒ†ãƒŠæƒ…å ±ã‚’ç·¨é›†' : 'ã‚³ãƒ³ãƒ†ãƒŠã‚’è¿½åŠ '}</h3>
                            <button class="close-btn" onclick="closeModal('container-modal')">âœ•</button>
                        </div>
                        <div class="modal-body">
                            <form id="container-form" onsubmit="submitContainerForm(event, '${customerId}')">
                                <input type="hidden" name="id" value="${container?.id || ''}">
                                
                                <h4 style="margin-bottom: 16px;">ğŸ“¦ ã‚³ãƒ³ãƒ†ãƒŠæƒ…å ±</h4>
                                
                                <div class="form-group">
                                    <label>ã‚³ãƒ³ãƒ†ãƒŠç•ªå· *</label>
                                    <input type="text" name="containerNumber" value="${container?.containerNumber || ''}" placeholder="ä¾‹: C-001" required>
                                </div>
                                
                                <div class="form-group">
                                    <label>ã‚³ãƒ³ãƒ†ãƒŠã‚¿ã‚¤ãƒ— *</label>
                                    <div style="display: flex; flex-direction: column; gap: 8px; align-items: flex-start;">
                                        ${['1.5ã¥', '2.5ã¥', '2.5ã¥é‰„ç± ', '3.0ã¥', '4.0ã¥', '5.0ã¥', 'ãƒ—ãƒ©ãƒ‰ãƒ©ãƒ '].map((type, index) => `
                                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; margin: 0;">
                                                <input type="radio" name="type" value="${type}" ${index === 0 && !container ? 'checked' : ''} ${container?.type === type ? 'checked' : ''} required style="margin: 0; flex-shrink: 0;">
                                                <span style="white-space: nowrap;">${type}</span>
                                            </label>
                                        `).join('')}
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label>è²¸å‡ºé–‹å§‹æ—¥ *</label>
                                    <input type="date" name="rentalStartDate" value="${container ? formatDate(container.rentalStartDate) : ''}" required>
                                </div>
                                
                                <div class="form-group">
                                    <label>è¨­ç½®å ´æ‰€</label>
                                    <input type="text" name="location" value="${container?.location || ''}" placeholder="ä¾‹: ç¾å ´Aï¼ˆâ—‹â—‹ç”ºå·¥äº‹ç¾å ´ï¼‰">
                                </div>
                                
                                <hr style="margin: 24px 0;">
                                
                                <h4 style="margin-bottom: 16px;">ğŸ’° è«‹æ±‚æƒ…å ±</h4>
                                
                                <div class="form-group">
                                    <label>è«‹æ±‚ã‚µã‚¤ã‚¯ãƒ« *</label>
                                    <div style="display: flex; gap: 16px;">
                                        <label style="display: flex; align-items: center; gap: 8px;">
                                            <input type="radio" name="billingCycle" value="å¹´é¡" ${!container || container.billingCycle === 'å¹´é¡' ? 'checked' : ''} onchange="updateBillingLabel()">
                                            <span>å¹´é¡</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 8px;">
                                            <input type="radio" name="billingCycle" value="æœˆé¡" ${container?.billingCycle === 'æœˆé¡' ? 'checked' : ''} onchange="updateBillingLabel()">
                                            <span>æœˆé¡</span>
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label>ãƒ¬ãƒ³ã‚¿ãƒ«æ–™ *</label>
                                    <input type="number" name="rentalFee" value="${container?.rentalFee || 60000}" required>
                                    <small id="billing-cycle-label">å††/${container?.billingCycle === 'æœˆé¡' ? 'æœˆ' : 'å¹´'}</small>
                                </div>
                                
                                <div class="form-group">
                                    <label>è«‹æ±‚æ—¥ *</label>
                                    <input type="date" name="billingDate" value="${container ? formatDate(container.billingDate) : ''}" required>
                                    <small style="display: block; margin-top: 4px; color: #64748b;">
                                        ğŸ“… å¹´ã«1å›ã®è«‹æ±‚æ—¥ã§ã™ã€‚30æ—¥å‰ã«é€šçŸ¥ã•ã‚Œã¾ã™ã€‚
                                    </small>
                                </div>
                                
                                <div class="form-group">
                                    <label>å‚™è€ƒ</label>
                                    <textarea name="notes" rows="3" placeholder="ç‰¹è¨˜äº‹é …ãŒã‚ã‚Œã°è¨˜å…¥">${container?.notes || ''}</textarea>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="closeModal('container-modal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                            <button type="submit" form="container-form" class="btn btn-primary">ä¿å­˜</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function updateBillingLabel() {
            const billingCycle = document.querySelector('input[name="billingCycle"]:checked').value;
            document.getElementById('billing-cycle-label').textContent = `å††/${billingCycle === 'å¹´é¡' ? 'å¹´' : 'æœˆ'}`;
        }

        async function submitContainerForm(event, customerId) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData.entries());
            
            try {
                showLoading('ä¿å­˜ä¸­...');
                
                const customer = state.customers.find(c => c.id === customerId);
                
                // æ¬¡å›è«‹æ±‚æ—¥ã‚’è¨ˆç®—
                const billingDate = new Date(data.billingDate);
                const nextBillingDate = new Date(billingDate);
                
                if (data.billingCycle === 'å¹´é¡') {
                    nextBillingDate.setFullYear(nextBillingDate.getFullYear() + 1);
                } else {
                    nextBillingDate.setMonth(nextBillingDate.getMonth() + 1);
                }
                
                const container = {
                    id: data.id || `cn${Date.now()}`,
                    containerNumber: data.containerNumber,
                    customerId: customerId,
                    customerName: customer.name,
                    type: data.type,
                    rentalStartDate: data.rentalStartDate,
                    billingDate: data.billingDate,
                    nextBillingDate: nextBillingDate.toISOString().split('T')[0],
                    status: 'ãƒ¬ãƒ³ã‚¿ãƒ«ä¸­',
                    rentalFee: parseInt(data.rentalFee) || 0,
                    billingCycle: data.billingCycle,
                    location: data.location,
                    notes: data.notes,
                    createdAt: data.id ? state.containers.find(c => c.id === data.id).createdAt : new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                const action = data.id ? 'update' : 'add';
                await gasPost(action, 'containers', container);
                
                if (action === 'update') {
                    const index = state.containers.findIndex(c => c.id === container.id);
                    state.containers[index] = container;
                } else {
                    state.containers.push(container);
                }
                
                closeModal('container-modal');
                hideLoading();
                alert('âœ… ä¿å­˜ã—ã¾ã—ãŸï¼');
                render();
                
            } catch (error) {
                console.error('âŒ ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                hideLoading();
            }
        }

        function editContainer(containerId) {
            const container = state.containers.find(c => c.id === containerId);
            openContainerForm(container.customerId, containerId);
        }

        async function returnContainer(containerId) {
            if (!confirm('ã“ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’è¿”å´ã—ã¾ã™ã‹ï¼Ÿ\nâ€»è¿”å´å¾Œã¯ã€Œç©ºãã€çŠ¶æ…‹ã«ãªã‚Šã¾ã™ã€‚')) return;
            
            try {
                showLoading('è¿”å´å‡¦ç†ä¸­...');
                
                const index = state.containers.findIndex(c => c.id === containerId);
                const container = state.containers[index];
                
                container.customerId = null;
                container.customerName = null;
                container.status = 'ç©ºã';
                container.location = '';
                container.updatedAt = new Date().toISOString();
                
                await gasPost('update', 'containers', container);
                state.containers[index] = container;
                
                hideLoading();
                alert('âœ… è¿”å´å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸï¼');
                render();
                
            } catch (error) {
                console.error('âŒ è¿”å´å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
                alert('è¿”å´å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                hideLoading();
            }
        }

        async function deleteContainer(containerId) {
            if (!confirm('ã“ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            
            try {
                showLoading('å‰Šé™¤ä¸­...');
                
                await gasPost('delete', 'containers', { id: containerId });
                state.containers = state.containers.filter(c => c.id !== containerId);
                
                hideLoading();
                alert('âœ… å‰Šé™¤ã—ã¾ã—ãŸ');
                render();
                
            } catch (error) {
                console.error('âŒ å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                hideLoading();
            }
        }

        async function completeBilling(containerId) {
            if (!confirm('ã“ã®è«‹æ±‚ã‚’å®Œäº†ã—ã¾ã™ã‹ï¼Ÿ\næ¬¡å›è«‹æ±‚æ—¥ãŒ1å¹´å¾Œã«æ›´æ–°ã•ã‚Œã¾ã™ã€‚')) return;
            
            try {
                showLoading('è«‹æ±‚å‡¦ç†ä¸­...');
                
                const index = state.containers.findIndex(c => c.id === containerId);
                const container = state.containers[index];
                
                const currentBillingDate = new Date(container.nextBillingDate);
                const nextBillingDate = new Date(currentBillingDate);
                
                if (container.billingCycle === 'å¹´é¡') {
                    nextBillingDate.setFullYear(nextBillingDate.getFullYear() + 1);
                } else {
                    nextBillingDate.setMonth(nextBillingDate.getMonth() + 1);
                }
                
                container.billingDate = container.nextBillingDate;
                container.nextBillingDate = nextBillingDate.toISOString().split('T')[0];
                container.updatedAt = new Date().toISOString();
                
                await gasPost('update', 'containers', container);
                state.containers[index] = container;
                
                hideLoading();
                alert('âœ… è«‹æ±‚å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸï¼\næ¬¡å›è«‹æ±‚æ—¥: ' + container.nextBillingDate);
                render();
                
            } catch (error) {
                console.error('âŒ è«‹æ±‚å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
                alert('è«‹æ±‚å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                hideLoading();
            }
        }

        // ========================================
        // CSVæ©Ÿèƒ½
        // ========================================
        function exportCustomersCSV() {
            if (state.customers.length === 0) {
                alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹é¡§å®¢ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            const headers = ['è«‹æ±‚ã‚³ãƒ¼ãƒ‰', 'äº‹æ¥­æ‰€å', 'ãƒ•ãƒªã‚¬ãƒŠ', 'æ¥­ç¨®', 'ä½æ‰€', 'é›»è©±ç•ªå·', 'FAX', 'ãƒ¡ãƒ¼ãƒ«', 'æ‹…å½“è€…', 'å›åæ›œæ—¥'];
            const rows = state.customers.map(c => [
                c.code || '',
                c.name || '',
                c.kana || '',
                c.type || '',
                c.address || '',
                c.tel || '',
                c.fax || '',
                c.email || '',
                c.contactPerson || '',
                c.collectionDay || ''
            ]);
            
            const csvContent = [headers, ...rows]
                .map(row => row.map(cell => `"${cell}"`).join(','))
                .join('\n');
            
            const bom = '\uFEFF';
            const blob = new Blob([bom + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `é¡§å®¢ãƒ‡ãƒ¼ã‚¿_${formatDate(new Date().toISOString())}.csv`;
            link.click();
            
            alert('âœ… CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ');
        }

        function importCustomersCSV() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.csv';
            
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        showLoading('ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­...');
                        
                        const text = event.target.result;
                        const lines = text.split('\n').filter(line => line.trim());
                        const data = lines.slice(1).map(line => {
                            const values = line.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];
                            return values.map(v => v.replace(/^"|"$/g, '').trim());
                        });
                        
                        let successCount = 0;
                        
                        for (const row of data) {
                            if (row.length < 2) continue;
                            
                            const customer = {
                                id: `c${Date.now()}_${successCount}`,
                                code: row[0] || '',
                                name: row[1] || '',
                                kana: row[2] || '',
                                type: row[3] || '',
                                address: row[4] || '',
                                tel: row[5] || '',
                                fax: row[6] || '',
                                email: row[7] || '',
                                contactPerson: row[8] || '',
                                collectionDay: row[9] || '',
                                notes: '',
                                slipInstructions: '',
                                contracts: '[]',
                                images: '[]',
                                createdAt: new Date().toISOString(),
                                updatedAt: new Date().toISOString()
                            };
                            
                            await gasPost('add', 'customers', customer);
                            state.customers.push(customer);
                            successCount++;
                            
                            await new Promise(resolve => setTimeout(resolve, 100));
                        }
                        
                        hideLoading();
                        alert(`âœ… ${successCount}ä»¶ã®é¡§å®¢ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ`);
                        render();
                        
                    } catch (error) {
                        console.error('âŒ ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                        alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                        hideLoading();
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }

        // ========================================
        // å¥‘ç´„æ›¸ãƒ»ç”»åƒãƒ»æ³¨æ„äº‹é …
        // ========================================
        function openContractForm(customerId) {
            const customer = state.customers.find(c => c.id === customerId);
            
            const modalHTML = `
                <div class="modal show" id="contract-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title">å¥‘ç´„æ›¸ã‚’è¿½åŠ </h3>
                            <button class="close-btn" onclick="closeModal('contract-modal')">âœ•</button>
                        </div>
                        <div class="modal-body">
                            <form id="contract-form" onsubmit="submitContractForm(event, '${customerId}')">
                                <div class="form-group">
                                    <label>å¥‘ç´„æ›¸å *</label>
                                    <input type="text" name="contractName" placeholder="ä¾‹: ç”£æ¥­å»ƒæ£„ç‰©å‡¦ç†å§”è¨—å¥‘ç´„æ›¸" required>
                                </div>
                                
                                <div class="form-group">
                                    <label>å¥‘ç´„æ›¸PDF URLï¼ˆGoogleãƒ‰ãƒ©ã‚¤ãƒ–ï¼‰ *</label>
                                    <input type="url" name="contractUrl" placeholder="https://drive.google.com/file/d/xxxxx/view" required>
                                    <small>ğŸ“ Googleãƒ‰ãƒ©ã‚¤ãƒ–ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ â†’ å…±æœ‰ â†’ ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼</small>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>å¥‘ç´„é–‹å§‹æ—¥</label>
                                        <input type="date" name="contractStartDate">
                                    </div>
                                    <div class="form-group">
                                        <label>å¥‘ç´„çµ‚äº†æ—¥</label>
                                        <input type="date" name="contractEndDate">
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label>å‚™è€ƒ</label>
                                    <input type="text" name="contractNotes" placeholder="ä¾‹: è‡ªå‹•æ›´æ–°">
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="closeModal('contract-modal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                            <button type="submit" form="contract-form" class="btn btn-primary">ä¿å­˜</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        async function submitContractForm(event, customerId) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData.entries());
            
            try {
                showLoading('ä¿å­˜ä¸­...');
                
                const customer = state.customers.find(c => c.id === customerId);
                const contracts = parseJSON(customer.contracts) || [];
                
                contracts.push({
                    id: `ct${Date.now()}`,
                    name: data.contractName,
                    url: data.contractUrl,
                    startDate: data.contractStartDate,
                    endDate: data.contractEndDate,
                    notes: data.contractNotes
                });
                
                customer.contracts = JSON.stringify(contracts);
                customer.updatedAt = new Date().toISOString();
                
                await gasPost('update', 'customers', customer);
                
                const index = state.customers.findIndex(c => c.id === customerId);
                state.customers[index] = customer;
                state.selectedCustomer = customer;
                
                closeModal('contract-modal');
                hideLoading();
                alert('âœ… å¥‘ç´„æ›¸ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼');
                render();
                
            } catch (error) {
                console.error('âŒ ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                hideLoading();
            }
        }

        function editNotes(customerId, field) {
            const customer = state.customers.find(c => c.id === customerId);
            const isNotes = field === 'notes';
            const title = isNotes ? 'å›åæ™‚ã®æ³¨æ„äº‹é …' : 'ä¼ç¥¨ã®æ›¸ãæ–¹';
            const currentValue = customer[field] || '';
            
            const modalHTML = `
                <div class="modal show" id="notes-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title">${title}ã‚’ç·¨é›†</h3>
                            <button class="close-btn" onclick="closeModal('notes-modal')">âœ•</button>
                        </div>
                        <div class="modal-body">
                            <form id="notes-form" onsubmit="submitNotesForm(event, '${customerId}', '${field}')">
                                <div class="form-group">
                                    <label>${title}</label>
                                    <textarea name="content" rows="10" style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 14px;">${currentValue}</textarea>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="closeModal('notes-modal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                            <button type="submit" form="notes-form" class="btn btn-primary">ä¿å­˜</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        async function submitNotesForm(event, customerId, field) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const content = formData.get('content');
            
            try {
                showLoading('ä¿å­˜ä¸­...');
                
                const customer = state.customers.find(c => c.id === customerId);
                customer[field] = content;
                customer.updatedAt = new Date().toISOString();
                
                await gasPost('update', 'customers', customer);
                
                const index = state.customers.findIndex(c => c.id === customerId);
                state.customers[index] = customer;
                state.selectedCustomer = customer;
                
                closeModal('notes-modal');
                hideLoading();
                alert('âœ… ä¿å­˜ã—ã¾ã—ãŸï¼');
                render();
                
            } catch (error) {
                console.error('âŒ ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                hideLoading();
            }
        }

        function openImageForm(customerId) {
            const customer = state.customers.find(c => c.id === customerId);
            
            const modalHTML = `
                <div class="modal show" id="image-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title">ç”»åƒã‚’è¿½åŠ </h3>
                            <button class="close-btn" onclick="closeModal('image-modal')">âœ•</button>
                        </div>
                        <div class="modal-body">
                            <form id="image-form" onsubmit="submitImageForm(event, '${customerId}')">
                                <div class="form-group">
                                    <label>ç”»åƒå *</label>
                                    <input type="text" name="imageName" placeholder="ä¾‹: å›åå ´æ‰€ã®å†™çœŸ" required>
                                </div>
                                
                                <div class="form-group">
                                    <label>ç”»åƒURLï¼ˆGoogleãƒ‰ãƒ©ã‚¤ãƒ–ï¼‰ *</label>
                                    <input type="url" name="imageUrl" placeholder="https://drive.google.com/file/d/xxxxx/view" required>
                                    <small>ğŸ“ Googleãƒ‰ãƒ©ã‚¤ãƒ–ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ â†’ å…±æœ‰ â†’ ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼</small>
                                </div>
                                
                                <div class="form-group">
                                    <label>èª¬æ˜</label>
                                    <input type="text" name="imageDescription" placeholder="ä¾‹: è£å£ã‹ã‚‰ã®å…¥ã‚Šæ–¹">
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="closeModal('image-modal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                            <button type="submit" form="image-form" class="btn btn-primary">ä¿å­˜</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        async function submitImageForm(event, customerId) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData.entries());
            
            try {
                showLoading('ä¿å­˜ä¸­...');
                
                const customer = state.customers.find(c => c.id === customerId);
                const images = parseJSON(customer.images) || [];
                
                images.push({
                    id: `img${Date.now()}`,
                    name: data.imageName,
                    url: data.imageUrl,
                    description: data.imageDescription
                });
                
                customer.images = JSON.stringify(images);
                customer.updatedAt = new Date().toISOString();
                
                await gasPost('update', 'customers', customer);
                
                const index = state.customers.findIndex(c => c.id === customerId);
                state.customers[index] = customer;
                state.selectedCustomer = customer;
                
                closeModal('image-modal');
                hideLoading();
                alert('âœ… ç”»åƒã‚’è¿½åŠ ã—ã¾ã—ãŸï¼');
                render();
                
            } catch (error) {
                console.error('âŒ ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                hideLoading();
            }
        }

        // ========================================
        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
        // ========================================
        function showLoading(text = 'èª­ã¿è¾¼ã¿ä¸­...') {
            document.getElementById('loading-text').textContent = text;
            document.getElementById('loading').classList.add('show');
        }

        function hideLoading() {
            document.getElementById('loading').classList.remove('show');
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.remove();
            }
        }

        function parseJSON(str) {
            try {
                return JSON.parse(str);
            } catch {
                return null;
            }
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            if (isNaN(date)) return dateString;
            return date.toISOString().split('T')[0];
        }

        function convertDriveUrl(url) {
            if (!url) return '';
            const match = url.match(/\/d\/(.+?)\//);
            if (match) {
                return `https://drive.google.com/thumbnail?id=${match[1]}&sz=w500`;
            }
            return url;
        }

        function getContractCount(customer) {
            const contracts = parseJSON(customer.contracts) || [];
            return contracts.length;
        }

        function getCustomerContainers(customerId) {
            return state.containers.filter(c => c.customerId === customerId && c.status === 'ãƒ¬ãƒ³ã‚¿ãƒ«ä¸­');
        }

        function getCustomerContainerCount(customerId) {
            return getCustomerContainers(customerId).length;
        }

        function daysUntilBilling(billingDate) {
            if (!billingDate) return null;
            const today = new Date();
            const billing = new Date(billingDate);
            return Math.ceil((billing - today) / (24 * 60 * 60 * 1000));
        }

        // ========================================
        // èµ·å‹•
        // ========================================
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
